<?php

/**
 * Implements of hook_views_api().
 */
function ext_views_views_api()
{
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'ext_views') . '/views',
  );
}

/**
 * Implements hook_theme()
 */
function ext_views_theme()
{
  return [
    'custom_view'    => [
      'variables' => ['view' => null],
      'template' => 'templates/custom-view',
    ],
    'custom_pager'    => [
      'variables' => ['query' => null, 'total' => null, 'per_page' => null],
    ],
  ];
}

function theme_custom_pager($vars)
{
  pager_default_initialize($vars['total'], $vars['per_page']);
  // пейджер формирует ссылку от текущего адреса, а он при ajax запросе = 'system/ajax'
  // поэтому меняем адрес на время формирования пейджера
  $bak = $_GET;
  $_GET = $vars['query'];
  $tags = ['«', '‹', ' ', '›', '»'];
  $pager = theme('pager', ['tags' => $tags]);
  $_GET = $bak;

  return $pager;
}

/**
 * Implements hook_preprocess_page().
 */
function ext_views_preprocess_page(&$vars)
{
  if ($GLOBALS['theme'] == 'kccc') {
    if (in_array(arg(0), ['blog', 'video']))         {
      $vars['banner_title'] = t('Publications');
      $vars['is_title_on'] = false;
    }
    if (in_array(arg(0), ['novosti', 'afisha']))     {
      $vars['banner_title'] = t('Events');
      $vars['is_title_on'] = false;
    }
    if (arg(0) == 'programmy-zashchity') {
      $vars['banner_title'] = t('Product portfolio for crop protection');
      $vars['is_title_on'] = false;
    }
    if (arg(0) == 'spravochniki') {
      $vars['banner_title'] = t('Handbooks');
    }
    if (arg(0) == 'vakansii') {
      $vars['banner_title'] = t('Careers');
    }
    if (in_array(arg(0), ['otzyvy', 'vakansii', 'preparaty-v-pole']))     {
      $vars['is_title_on'] = false;
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function ext_views_preprocess_views_view_unformatted(&$vars)
{
  if ($vars['view']->name == 'search') {
    // скорректировать заголовок группы
//    $arr = ['Препараты в поле' => 'Примеры применения препаратов', 'Отзыв' => 'Отзывы', 'Блог' => 'Блоги', 'Справочник | Сорное растение' => 'Справочник сорных растений', 'Препарат' => 'Препараты',
//      'Программа защиты' => 'Программы защиты', 'Вакансия' => 'Вакансии', 'Справочник | Культура' => 'Справочник культур',
//      'Справочник | Болезнь культуры' => 'Справочник болезней культур', 'Справочник | Вредитель культуры' => 'Справочник вредителей культур', 'Новость' => 'Новости',
//      '' => ''];
    $arr = [t('Products in the fields') => t('Demonstration tests in the fields'), t('Review') => t('Reviews'), t('Blog') => t('Blogs'),
      'Справочник | Сорное растение' => 'Справочник сорных растений', t('Product') => t('Products'),
      'Программа защиты' => 'Программы защиты', 'Вакансия' => 'Вакансии', 'Справочник | Культура' => 'Справочник культур',
      'Справочник | Болезнь культуры' => 'Справочник болезней культур', 'Справочник | Вредитель культуры' => 'Справочник вредителей культур', 'Новость' => 'Новости',
      '' => ''];
    $vars['title'] = $arr[$vars['title']] ?? $vars['title'];

    // размер карточек в зависимости от типа материала
    foreach ($vars['rows'] as $id => $result) {
      $class = 'col-xs-12 col-md-6';
      if (in_array($vars['view']->result[$id]->_entity_properties["type"], ['season', 'culture', 'weed', 'pest', 'disease', 'vacancy'])) {
        $class = 'col-xs-12 col-md-4 col-lg-3';
      }
      if (in_array($vars['view']->result[$id]->_entity_properties["type"], ['blog', 'review', 'article', 'agenda'])) {
        $class = 'col-xs-12 col-md-4 col-lg-4';
      }
      $vars["classes_array"][$id] = $vars["classes_array"][$id] ? $vars["classes_array"][$id] . ' ' . $class : $class;
    }
  }
}

/**
 * Вернуть exposed form заданного view
 * https://pro-cosmos.blogspot.com/2011/08/exposed.html
 */
function ext_views_get_view_exposed_form($view_name, $display_id = 'page')
{
  if ($view = views_get_view($view_name)) {
    if ($view->access($display_id)) {
      $view->set_display($display_id);
      if (isset($view->display_handler)) {
        $view->init_handlers();
        if ($view->display_handler->uses_exposed()) {
          $exposed_form = $view->display_handler->get_plugin('exposed_form');
          $rendered_form = $exposed_form->render_exposed_form();
          $view->destroy();
          return $rendered_form;
        }
      }
    }
    $view->destroy();
  }

  drupal_set_message(t('Something went wrong'), 'error');
  return '';
}

/**
 * Implements hook_views_filters_selective_sort_alter().
 */
function ext_views_views_filters_selective_sort_alter(array &$oids, $handler)
{
  $items = $oids;
  // исключить из Selective фильтров значения Empty
  foreach($items as $key => $item) {
    if (strpos(drupal_strtolower($item), 'empty') !== false) unset($oids[$key]);
  }
}
